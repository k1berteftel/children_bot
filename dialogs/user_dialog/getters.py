import random

from aiogram.types import CallbackQuery, User, Message
from aiogram_dialog import DialogManager, ShowMode
from aiogram_dialog.api.entities import MediaAttachment
from aiogram_dialog.widgets.kbd import Button, Select
from aiogram_dialog.widgets.input import ManagedTextInput

from database.action_data_class import DataInteraction
from config_data.config import load_config, Config
from states.state_groups import startSG, PaymentSG


config: Config = load_config()


async def start_getter(event_from_user: User, dialog_manager: DialogManager, **kwargs):
    session: DataInteraction = dialog_manager.middleware_data.get('session')
    admin = False
    admins = [*config.bot.admin_ids]
    admins.extend([admin.user_id for admin in await session.get_admins()])
    if event_from_user.id in admins:
        admin = True
    return {'admin': admin}


async def form_switcher(clb: CallbackQuery, widget: Button, dialog_manager: DialogManager):
    dialog_manager.dialog_data['mode'] = clb.data.split('_')[0]
    await dialog_manager.switch_to(startSG.choose_time)


async def choose_rate_switcher(clb: CallbackQuery, widget: Button, dialog_manager: DialogManager):
    mode = dialog_manager.dialog_data.get('mode')
    if mode == 'child':
        await dialog_manager.switch_to(startSG.child_rate_choose)
    else:
        await dialog_manager.switch_to(startSG.recipe_rate_choose)


async def child_rate_choose_getter(dialog_manager: DialogManager, **kwargs):
    text = (f'<b>–°–ø–∞—Å–∏–±–æ –∑–∞ –≤–∞—à–∏ –æ—Ç–≤–µ—Ç—ã!</b> –ù–∞ –æ—Å–Ω–æ–≤–µ –∞–Ω–∫–µ—Ç—ã —è —Å–æ—Å—Ç–∞–≤–∏–ª –Ω–µ–±–æ–ª—å—à–æ–π –ø–æ—Ä—Ç—Ä–µ—Ç –≤–∞—à–µ–π —Å–∏—Ç—É–∞—Ü–∏–∏ '
            f'—Å —Ä–∞–∑–≤–∏–≤–∞—é—â–∏–º–∏ –∏–≥—Ä–∞–º–∏.\n\n<b>–í–∞—à —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≥–æ—Ç–æ–≤!</b>\nüí°<b>–£—Ä–æ–≤–µ–Ω—å –∏–≥—Ä–æ–≤–æ–≥–æ —Ä–µ—Å—É—Ä—Å–∞ –¥–ª—è —Ä–∞–∑–≤–∏—Ç–∏—è –º–∞–ª—ã—à–∞: '
            f'{random.randint(35, 65)}%.</b>\n\n<blockquote>–≠—Ç–æ—Ç –ø–æ–∫–∞–∑–∞—Ç–µ–ª—å –≥–æ–≤–æ—Ä–∏—Ç –æ —Ç–æ–º, —á—Ç–æ —É –≤–∞—Å –µ—Å—Ç—å –±–æ–ª—å—à–æ–µ '
            f'–∂–µ–ª–∞–Ω–∏–µ –¥–∞—Ä–∏—Ç—å —Ä–µ–±–µ–Ω–∫—É –ø–æ–ª–µ–∑–Ω—ã–µ –≤–ø–µ—á–∞—Ç–ª–µ–Ω–∏—è, –Ω–æ —á–∞—Å—Ç–æ –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç –≥–æ—Ç–æ–≤—ã—Ö —Ä–µ—à–µ–Ω–∏–π –∏ —Å–∏—Å—Ç–µ–º—ã, '
            f'—á—Ç–æ–±—ã –ø—Ä–µ–≤—Ä–∞—Ç–∏—Ç—å —ç—Ç–æ –≤ –µ–∂–µ–¥–Ω–µ–≤–Ω—É—é –ª—ë–≥–∫—É—é –ø—Ä–∏–≤—ã—á–∫—É –±–µ–∑ –ø–æ–∏—Å–∫–æ–≤ –∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏.</blockquote>\n\n'
            f'<b>üß©–ü–æ–∑–≤–æ–ª—å—Ç–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç—å —Ä–µ—à–µ–Ω–∏–µ ‚Äî —Ç–∞—Ä–∏—Ñ <u>¬´–†–∞–∑–≤–∏–≤–∞—à–∫–∏¬ª</u>!</b>\n–ö–∞–∂–¥—ã–π –¥–µ–Ω—å –≤—ã –±—É–¥–µ—Ç–µ –ø–æ–ª—É—á–∞—Ç—å '
            f'–≥–æ—Ç–æ–≤—É—é –∏–≥—Ä—É, –∫–æ—Ç–æ—Ä–∞—è:\n ‚Ä¢ <b>–†–∞–∑–≤–∏–≤–∞–µ—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –Ω–∞–≤—ã–∫</b> (–ª–æ–≥–∏–∫—É, —Ä–µ—á—å, –º–æ—Ç–æ—Ä–∏–∫—É) —á–µ—Ä–µ–∑ –≤–µ—Å–µ–ª—å–µ.\n'
            f' ‚Ä¢ <b>–ù–µ —Ç—Ä–µ–±—É–µ—Ç –¥–æ–ª–≥–æ–π –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏</b> ‚Äî –º–∞—Ç–µ—Ä–∏–∞–ª—ã –µ—Å—Ç—å –≤ –∫–∞–∂–¥–æ–º –¥–æ–º–µ.\n ‚Ä¢ <b>–î–∞—Ä–∏—Ç –≤–∞–º —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å</b>, '
            f'—á—Ç–æ –≤—Ä–µ–º—è —Å —Ä–µ–±–µ–Ω–∫–æ–º –ø—Ä–æ—Ö–æ–¥–∏—Ç —Å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –ø–æ–ª—å–∑–æ–π –∏ —Ä–∞–¥–æ—Å—Ç—å—é.\n\n–≠—Ç–æ –≤–∞—à —à–∞–Ω—Å –∑–∞–º–µ–Ω–∏—Ç—å ¬´–≤–æ —á—Ç–æ –±—ã '
            f'–ø–æ–∏–≥—Ä–∞—Ç—å?¬ª –Ω–∞ –≥–æ—Ç–æ–≤—ã–π –ø–ª–∞–Ω —Ä–∞–∑–≤–∏—Ç–∏—è, –æ—Å–≤–æ–±–æ–¥–∏–≤ –≤—Ä–µ–º—è –¥–ª—è —Å–µ–±—è.\n\n<blockquote>üçΩ –û–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ: '
            f'–ß–∞—Å—Ç–æ –º–∞–º—ã, –∫–æ—Ç–æ—Ä—ã–µ –±–µ—Ä—É—Ç –∏–≥—Ä—ã, –≤—Å–∫–æ—Ä–µ —Å–ø—Ä–∞—à–∏–≤–∞—é—Ç –∏ –ø—Ä–æ —Ä–µ—Ü–µ–ø—Ç—ã, —á—Ç–æ–±—ã –≤—ã—Å—Ç—Ä–æ–∏—Ç—å –≤–µ—Å—å –¥–µ–Ω—å —Ä–µ–±–µ–Ω–∫–∞ '
            f'–≥–∞—Ä–º–æ–Ω–∏—á–Ω–æ. –û–±—ä–µ–¥–∏–Ω–µ–Ω–Ω—ã–π —Ç–∞—Ä–∏—Ñ ¬´–í—Å—ë –≤–∫–ª—é—á–µ–Ω–æ¬ª (–†–∞–∑–≤–∏–≤–∞—à–∫–∏ + –†–µ—Ü–µ–ø—Ç—ã) –ø–æ–º–æ–≥–∞–µ—Ç —Å–æ–∑–¥–∞—Ç—å –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—É—é '
            f'—Ä–∞–∑–≤–∏–≤–∞—é—â—É—é —Å—Ä–µ–¥—É –∏ —ç–∫–æ–Ω–æ–º–∏—Ç –º–∞–∫—Å–∏–º—É–º —Å–∏–ª</blockquote>')
    return {
        'text': text
    }


async def recipe_rate_choose_getter(dialog_manager: DialogManager, **kwargs):
    text = ('<b>–°–ø–∞—Å–∏–±–æ –∑–∞ –≤–∞—à–∏ –æ—Ç–≤–µ—Ç—ã!</b> –ù–∞ –æ—Å–Ω–æ–≤–µ –∞–Ω–∫–µ—Ç—ã —è —Å–æ—Å—Ç–∞–≤–∏–ª –Ω–µ–±–æ–ª—å—à–æ–π –ø–æ—Ä—Ç—Ä–µ—Ç –≤–∞—à–µ–π —Å–∏—Ç—É–∞—Ü–∏–∏.\n\n'
            f'<b>–í–∞—à —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≥–æ—Ç–æ–≤!</b>\nüí°<b>–£—Ä–æ–≤–µ–Ω—å –∫—É–ª–∏–Ω–∞—Ä–Ω–æ–π —Ä–µ—Å—É—Ä—Å–Ω–æ—Å—Ç–∏: '
            f'{random.randint(35, 65)}%.</b>\n\n<blockquote>–≠—Ç–æ—Ç –ø–æ–∫–∞–∑–∞—Ç–µ–ª—å –æ—Ç—Ä–∞–∂–∞–µ—Ç, –Ω–∞—Å–∫–æ–ª—å–∫–æ –ª–µ–≥–∫–æ –≤–∞–º —Å–µ–π—á–∞—Å –¥–∞—é—Ç—Å—è '
            f'—Ä–µ–≥—É–ª—è—Ä–Ω—ã–µ —Ä–∞–∑–≤–∏–≤–∞—é—â–∏–µ –∏–≥—Ä—ã. –ß–∞—Å—Ç–æ –∑–∞–±–æ—Ç–∞ –æ –±—ã—Ç–µ –∏ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏ –º–µ–Ω—é –∑–∞–±–∏—Ä–∞–µ—Ç —Ç–µ —Å–∏–ª—ã –∏ –≤—Ä–µ–º—è, '
            f'–∫–æ—Ç–æ—Ä—ã–µ —Ö–æ—Ç–µ–ª–æ—Å—å –±—ã –Ω–∞–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ –æ–±—â–µ–Ω–∏–µ –∏ —Ä–∞–∑–≤–∏—Ç–∏–µ —Ä–µ–±–µ–Ω–∫–∞.</blockquote>\n\n<b>üçï –ò–¥–µ–∞–ª—å–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ ‚Äî –Ω–∞—á–∞—Ç—å —Å '
            f'—Ç–∞—Ä–∏—Ñ–∞ ¬´–†–µ—Ü–µ–ø—Ç—ã¬ª!</b>\n–ü–æ—Ä—è–¥–æ–∫ –≤ –≤–æ–ø—Ä–æ—Å–∞—Ö –ø–∏—Ç–∞–Ω–∏—è —Å–æ–∑–¥–∞–µ—Ç —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç –¥–ª—è –≤—Å–µ–≥–æ –æ—Å—Ç–∞–ª—å–Ω–æ–≥–æ. '
            f'–ü–æ–¥–ø–∏—Å–∫–∞ –¥–∞—Å—Ç –≤–∞–º:\n ‚Ä¢ <b>–ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –ø—Ä–æ—Å—Ç–æ–π —Ä–µ—Ü–µ–ø—Ç</b>, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–Ω—Ä–∞–≤–∏—Ç—Å—è –≤—Å–µ–π —Å–µ–º—å–µ.\n ‚Ä¢ <b>–ß–µ—Ç–∫–∏–π '
            f'—Å–ø–∏—Å–æ–∫ –ø–æ–∫—É–ø–æ–∫</b>, —á—Ç–æ–±—ã –Ω–µ —Ç—Ä–∞—Ç–∏—Ç—å –≤—Ä–µ–º—è –≤ –º–∞–≥–∞–∑–∏–Ω–µ.\n ‚Ä¢ <b>–û—Å–≤–æ–±–æ–¥–∏–≤—à–∏–µ—Å—è —á–∞—Å—ã –∏ —ç–Ω–µ—Ä–≥–∏—é</b>, '
            f'–∫–æ—Ç–æ—Ä—ã–µ –º–æ–∂–Ω–æ —Å–º–µ–ª–æ –ø–æ—Å–≤—è—Ç–∏—Ç—å –∏–≥—Ä–∞–º –∏ —Ä–∞–∑–≤–∏—Ç–∏—é.\n–ù–∞–≤–µ–¥–∏—Ç–µ –ø–æ—Ä—è–¥–æ–∫ –Ω–∞ –∫—É—Ö–Ω–µ ‚Äî –∏ –≤—ã —É–¥–∏–≤–∏—Ç–µ—Å—å, —Å–∫–æ–ª—å–∫–æ '
            f'—Ä–µ—Å—É—Ä—Å–æ–≤ –æ—Ç–∫—Ä–æ–µ—Ç—Å—è –¥–ª—è –≤—Å–µ–≥–æ –æ—Å—Ç–∞–ª—å–Ω–æ–≥–æ!\n\n<blockquote>üé® –û–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ: –ö–æ–≥–¥–∞ –≥–æ—Ç–æ–≤–∫–∞ –ø–µ—Ä–µ—Å—Ç–∞–Ω–µ—Ç '
            f'–±—ã—Ç—å —Ä—É—Ç–∏–Ω–æ–π, –≤—ã —Å–º–æ–∂–µ—Ç–µ —Å –Ω–æ–≤—ã–º–∏ —Å–∏–ª–∞–º–∏ –≤–∑—è—Ç—å—Å—è –∑–∞ —Ä–∞–∑–≤–∏–≤–∞—é—â–∏–µ –∏–≥—Ä—ã. –û–±—ä–µ–¥–∏–Ω–µ–Ω–Ω—ã–π —Ç–∞—Ä–∏—Ñ ¬´–í—Å—ë –≤–∫–ª—é—á–µ–Ω–æ¬ª '
            f'(–†–µ—Ü–µ–ø—Ç—ã + –†–∞–∑–≤–∏–≤–∞—à–∫–∏) ‚Äî —ç—Ç–æ –ø–æ–ª–Ω—ã–π —Ü–∏–∫–ª –∑–∞–±–æ—Ç—ã: –ø–æ–ª–µ–∑–Ω–∞—è –µ–¥–∞ –¥–ª—è —ç–Ω–µ—Ä–≥–∏–∏ –∏ –≥–æ—Ç–æ–≤—ã–µ –∏–≥—Ä—ã –¥–ª—è —Ä–∞–∑–≤–∏—Ç–∏—è. '
            f'–≠—Ç–æ —Å–∞–º—ã–π –≤—ã–≥–æ–¥–Ω—ã–π –∏ —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø–æ–¥—Ö–æ–¥.</blockquote>')
    return {
        'text': text
    }


async def rate_choose(clb: CallbackQuery, widget: Button, dialog_manager: DialogManager):
    rate = clb.data.split('_')[0]
    cost = 299 if rate in ['child', 'recipe'] else 499
    data = {
        'rate': rate,
        'cost': cost
    }
    await dialog_manager.start(PaymentSG.choose_payment_type, data=data)
